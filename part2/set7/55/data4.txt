# If the OS is FreeBSD, use gmake instead of make
This Makefile is suitable for building small C++ projects.
## Most basic use:
    make clean
* C++ source files and internal headers will be preprocessed in order to
  function) will be linked against the convenience library to become

They can also be set in a file `hooks.mk`, which if it exists, will be
When setting extensions, do NOT include the dot in the extension!
                but not necessarily from being used if they exist.
Some files can be created from templates integrated in this Makefile.
    make parser/grammar.bc++
It is convenient to create the header first, because the template for the
This requires a metadata.txt in the set dir and order.txt files in the

ALL_FILES := $(patsubst ./%,%,$(call rwildcard,.,*))
# -pedantic -fsanitize=address,leak,null,bounds,object-size,pointer-overflow,undefined -fanalyzer -Wno-unused-variable -Wstrict-aliasing'

DEP_EXTENSION ?= dep
# Try: 'make VERBOSE=1'
DEP ?= true
SHAREDLIB_FILE = lib$(SHAREDLIB).$(SHAREDLIB_EXTENSION)
## No editing below this line unless you know what you're doing. ##


#SP is for alignments
# QUIET is a '@', unless VERBOSE is true.
rdir=$(foreach d,$(call maybe_dir,$1),$d $(call rdir,$(patsubst %/,%,$d)))
deps_of = $(addprefix $(DEPDIR)/,$(addsuffix .$(DEP_EXTENSION),$(1)))
# To detect a main() function in a source file.
CXX_TESTPROGS := $(filter tests/%,$(CXX_PROGS))

FLEXCXX_SCANNERSPECS := $(filter %.$(FLEXCXX_SCANNERSPEC_EXTENSION),$(ALL_FILES))
# Could be used to suppress all built-in rules.
	$(QUIET) $(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<
# To allow for a separate C library, *.cc builds *.cc.o, not *.o.
# Default target: to make all programs, or at least the convenience library.

$(CXX_PRECOMPILED_HEADERS): METHOD = Pre-compile
#$(info generated extensions: $(GENERATED_EXTENSIONS))
UNKNOWN_GENERATED_FILES = $(filter-out $(KNOWN_GENERATED_FILES),$(EVER_GENERATED_FILES))
# This output usually shows instead of the actual command.
	$(ECHO_ACTION)
$(SHAREDLIB_FILE): $(CXX_NONPROG_OBJECTS)
# 4. it won't work with parallel Make.
# If the source is newer than its object, we compile it.



    # The requested metadata.txt with full path.
	$(QUIET) printf '$(subst $(NEWLINE),\n,$(TEMPLATE))' >> "$(@)"
	@echo "If this is your first submission, leave the rater blank."

	@echo "$(@) made from template:"
	@echo "Please do not submit executables and other binaries."
    ZIPFILE = $(notdir $(CURDIR)).zip
            $(info However, there is one in the parent directory.)
            $(info No metadata.txt found in the tree, nor in the parent dir.)
        # One metadata.txt found.
        ifeq (metadata.txt,$(filter metadata.txt,$(METADATAS)))
            $(error Multiple metadata.txt but not in the right place.)

    endif



	@printf '$(subst $(NEWLINE),\n,$(HELP_TEXT))'


define CXX_HEADER_TEMPLATE
include-headers-in-same-dir = $(foreach HEADER,$(wildcard $(@D)/*.$(CXX_HEADER_EXTENSION)),#include "$(notdir $(HEADER))"\n)
using namespace std;\n

enum ExitCode
    try
    }
    try
    catch (...)
define FLEXCXX_SCANNERSPEC_TEMPLATE
//%%filenames = "basename"
//%%no-lines

// %%namespace pns

// %%token-path: defining the path of the file containing the Tokens_ enumeration
%%%%
# Metadata.txt template (but not by extension, so not in TEMPLATABLE_GOALS

# create only files that are explicitly mentioned on the command line, and

    %.$(CXX_HEADER_EXTENSION): HID = $(basename $(notdir $@))
endif
    # only of targets that don't need dependencies.

    undefine NEED_DEP_INCLUDES

	$(ECHO_ACTION)
    $(FLEXCXX_DEPS): $(call deps_of,%): %
	$(QUIET) mkdir -p $(dir $@)
    # reason this works is because Make will update includes before handling
    # Keep deps once we have them.
	$(QUIET) rm -f $(ALL_DEPS)

	@echo "    [ Substituting \"$$<\" <- \"$$@\": same file by straightened path. ]"

    # Each internal header shall become a precompiled header.

	grep -E '^[[:space:]]*#include[[:space:]]"' $(CXX_SOURCES) $(CXX_INTERNAL_HEADERS)|awk '{ sub(/:[[:space:]]*#include/, "", $$0); gsub(/^[[:space:]]+|[[:space:]]+$$/, "", $$1); print $$2, " -> \"" $$1 "\" [label = inc] " }' > $@
